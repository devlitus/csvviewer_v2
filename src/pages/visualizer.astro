---
import AppLayout from "../layouts/AppLayout.astro";
import Sidebar from "../components/layout/Sidebar.astro";
import Header from "../components/layout/Header.astro";
import MainContent from "../components/layout/MainContent.astro";
import Icon from "../components/ui/Icon.astro";

const breadcrumb = [{ label: "Visualizer", href: "/visualizer" }];
---

<AppLayout title="DataFlow - CSV Visualizer">
    <Sidebar currentPage="visualizer" />
    <div class="flex-1 flex flex-col h-full min-w-0">
        <Header breadcrumbItems={breadcrumb} />
        <MainContent>
            <!-- Loading state -->
            <div
                id="loading-state"
                class="flex flex-col items-center justify-center py-20 text-center"
            >
                <div class="animate-spin mb-4">
                    <Icon
                        name="progress_activity"
                        size="lg"
                        class="text-vibrant-blue"
                    />
                </div>
                <p class="text-text-light-gray">Loading CSV data...</p>
            </div>

            <!-- Error state -->
            <div
                id="error-state"
                class="hidden flex flex-col items-center justify-center py-20 text-center"
            >
                <Icon name="error" size="lg" class="text-red-500 mb-4" />
                <h3 class="text-xl font-semibold text-text-off-white mb-2">
                    Error loading file
                </h3>
                <p id="error-message" class="text-text-light-gray"></p>
                <a
                    href="/files"
                    class="mt-6 px-4 py-2 bg-vibrant-blue text-text-off-white rounded hover:bg-primary-hover transition-colors"
                >
                    Go back to files
                </a>
            </div>

            <!-- Data state -->
            <div id="data-state" class="hidden flex flex-col flex-1 min-h-0">
                <!-- Toolbar -->
                <div class="flex-shrink-0 px-8 py-6">
                    <div
                        class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"
                    >
                        <div class="flex flex-col gap-1">
                            <h2
                                class="text-xl font-bold text-text-off-white tracking-tight"
                            >
                                Data Preview
                            </h2>
                            <p
                                id="record-info"
                                class="text-xs text-text-light-gray"
                            >
                            </p>
                        </div>
                        <div class="flex items-center gap-3 w-full sm:w-auto">
                            <div class="relative flex-1 sm:flex-initial group">
                                <span
                                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-text-light-gray group-focus-within:text-vibrant-blue"
                                    style="font-size: 18px;">filter_alt</span
                                >
                                <input
                                    type="text"
                                    placeholder="Filter columns..."
                                    class="bg-background-dark border border-border-dark rounded-lg py-1.5 pl-9 pr-3 text-sm text-text-off-white focus:border-vibrant-blue focus:ring-1 focus:ring-vibrant-blue placeholder-text-light-gray w-full sm:w-64 transition-colors"
                                />
                            </div>
                            <div
                                class="relative"
                                id="filter-dropdown-container"
                            >
                                <button
                                    id="filter-toggle-btn"
                                    class="flex items-center gap-2 px-3 py-1.5 bg-surface-card border border-border-dark rounded-lg text-text-light-gray hover:text-text-off-white hover:border-text-light-gray/50 text-sm font-medium transition-colors"
                                >
                                    <span
                                        class="material-symbols-outlined"
                                        style="font-size: 18px;">tune</span
                                    > Filter
                                </button>
                                <div
                                    id="filter-menu"
                                    class="hidden absolute right-0 top-full mt-2 w-56 bg-surface-card border border-border-dark rounded-xl shadow-2xl z-50 overflow-hidden flex flex-col"
                                >
                                    <div
                                        class="px-3 py-2 border-b border-border-dark bg-surface-card/50"
                                    >
                                        <span
                                            class="text-xs font-semibold text-text-light-gray uppercase tracking-wider"
                                            >Select Columns</span
                                        >
                                    </div>
                                    <div
                                        id="filter-columns-list"
                                        class="max-h-64 overflow-y-auto p-1"
                                    >
                                    </div>
                                    <div
                                        class="p-2 border-t border-border-dark bg-surface-card/50 flex justify-end"
                                    >
                                        <button
                                            id="apply-filters-btn"
                                            class="text-xs font-semibold text-vibrant-blue hover:text-primary-hover px-2 py-1 rounded"
                                            >Apply</button
                                        >
                                    </div>
                                </div>
                            </div>
                            <div class="relative" id="export-container">
                                <button
                                    id="export-toggle-btn"
                                    class="flex items-center gap-2 px-3 py-1.5 bg-vibrant-blue hover:bg-primary-hover text-white rounded-lg text-sm font-bold transition-colors shadow-lg shadow-vibrant-blue/20"
                                >
                                    <span
                                        class="material-symbols-outlined"
                                        style="font-size: 18px;">download</span
                                    > Export
                                    <span
                                        class="material-symbols-outlined"
                                        style="font-size: 18px;"
                                        >expand_more</span
                                    >
                                </button>
                                <div
                                    id="export-menu"
                                    class="hidden absolute right-0 top-full mt-2 w-48 bg-surface-card border border-border-dark rounded-xl shadow-2xl z-50 overflow-hidden flex flex-col"
                                >
                                    <button
                                        id="export-csv"
                                        class="flex items-center gap-3 px-4 py-3 hover:bg-white/5 text-left transition-colors group border-b border-border-dark"
                                    >
                                        <span
                                            class="material-symbols-outlined text-vibrant-blue"
                                            style="font-size: 18px;"
                                            >description</span
                                        >
                                        <div class="flex flex-col">
                                            <span
                                                class="text-sm font-medium text-text-off-white"
                                                >CSV</span
                                            >
                                            <span
                                                class="text-xs text-text-light-gray"
                                                >Comma separated</span
                                            >
                                        </div>
                                    </button>
                                    <button
                                        id="export-xlsx"
                                        class="flex items-center gap-3 px-4 py-3 hover:bg-white/5 text-left transition-colors group"
                                    >
                                        <span
                                            class="material-symbols-outlined text-emerald-500"
                                            style="font-size: 18px;"
                                            >table_view</span
                                        >
                                        <div class="flex flex-col">
                                            <span
                                                class="text-sm font-medium text-text-off-white"
                                                >Excel</span
                                            >
                                            <span
                                                class="text-xs text-text-light-gray"
                                                >.xlsx Spreadsheet</span
                                            >
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table container -->
                <div
                    class="flex-1 overflow-hidden px-8 pb-8 flex flex-col min-w-0"
                >
                    <div
                        class="flex-1 bg-background-dark border border-border-dark rounded-xl flex flex-col shadow-inner overflow-hidden min-w-0"
                    >
                        <div
                            id="csv-table-container"
                            class="overflow-auto flex-1 w-full"
                        >
                        </div>

                        <!-- Footer con paginaciÃ³n -->
                        <div
                            class="border-t border-border-dark bg-surface-card p-3 flex items-center justify-between"
                        >
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-text-light-gray"
                                    >Rows per page:</span
                                >
                                <select
                                    id="rows-per-page"
                                    class="bg-background-dark border border-border-dark rounded text-xs text-text-off-white py-1 pl-2 pr-6 focus:ring-1 focus:ring-vibrant-blue focus:border-vibrant-blue"
                                >
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50" selected>50</option>
                                    <option value="100">100</option>
                                    <option value="all">All</option>
                                </select>
                            </div>
                            <div
                                id="pagination-controls"
                                class="flex items-center gap-2"
                            >
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </MainContent>
    </div>
</AppLayout>

<script>
    import { getFile } from "../lib/indexeddb";
    import { parseCSVString } from "../lib/csvParser";
    import * as XLSX from "xlsx";

    interface Column {
        key: string;
        label: string;
        align: "left" | "right";
    }

    let allData: Record<string, string>[] = [];
    let columns: Column[] = [];
    let currentPage = 1;
    let limit = 50;
    let currentFileId = "";
    let currentFilename = "";
    const hiddenColumns = new Set<string>();

    function showState(state: "loading" | "error" | "data") {
        document
            .getElementById("loading-state")!
            .classList.toggle("hidden", state !== "loading");
        document
            .getElementById("error-state")!
            .classList.toggle("hidden", state !== "error");
        document
            .getElementById("data-state")!
            .classList.toggle("hidden", state !== "data");
    }

    function showError(message: string) {
        document.getElementById("error-message")!.textContent = message;
        showState("error");
    }

    function renderTable() {
        const container = document.getElementById("csv-table-container")!;
        const totalRecords = allData.length;
        const effectiveLimit = limit === 0 ? totalRecords : limit;
        const totalPages = Math.max(
            1,
            Math.ceil(totalRecords / effectiveLimit),
        );
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;

        const startIndex = (currentPage - 1) * effectiveLimit;
        const endIndex = Math.min(startIndex + effectiveLimit, totalRecords);
        const pageData = allData.slice(startIndex, endIndex);

        // Update record info
        document.getElementById("record-info")!.textContent =
            `Showing ${totalRecords > 0 ? startIndex + 1 : 0}-${endIndex} rows from ${totalRecords.toLocaleString()} total records`;

        // Build table
        const visibleCols = columns.filter((c) => !hiddenColumns.has(c.key));

        const headerHtml = visibleCols
            .map(
                (col) =>
                    `<th data-col="${col.key}" class="px-6 py-4 font-semibold text-text-light-gray border-b border-border-dark ${col.align === "right" ? "text-right" : ""}">
                <div class="flex items-center gap-1 cursor-pointer hover:text-text-off-white ${col.align === "right" ? "justify-end" : ""}">${col.label}</div>
            </th>`,
            )
            .join("");

        const bodyHtml = pageData
            .map((row, idx) => {
                const bgClass =
                    idx % 2 === 1 ? "bg-surface-card/20" : "bg-background-dark";
                const cells = visibleCols
                    .map((col) => {
                        if (col.key === "actions") {
                            return `<td class="px-4 py-3.5 text-right">
                        <button class="text-text-light-gray hover:text-vibrant-blue opacity-0 group-hover:opacity-100 transition-all">
                            <span class="material-symbols-outlined" style="font-size: 18px;">edit</span>
                        </button>
                    </td>`;
                        }
                        const value = row[col.key] ?? "";
                        const isRight = col.align === "right";
                        const textClass =
                            col.key === "id"
                                ? "font-mono text-text-light-gray"
                                : "text-text-off-white";
                        return `<td data-col="${col.key}" class="px-6 py-3.5 ${isRight ? "text-right" : ""}">
                    <span class="${textClass}">${escapeHtml(String(value))}</span>
                </td>`;
                    })
                    .join("");
                return `<tr class="${bgClass} hover:bg-surface-card/40 transition-colors group">${cells}</tr>`;
            })
            .join("");

        container.innerHTML = `
            <table class="w-full text-left text-sm whitespace-nowrap">
                <thead class="bg-surface-card sticky top-0 z-10 shadow-sm"><tr>${headerHtml}</tr></thead>
                <tbody class="divide-y divide-border-dark/50 text-text-off-white">${bodyHtml}</tbody>
            </table>`;

        // Update rows-per-page select
        const select = document.getElementById(
            "rows-per-page",
        ) as HTMLSelectElement;
        if (select) {
            for (const opt of select.options) {
                opt.selected =
                    (limit === 0 && opt.value === "all") ||
                    opt.value === String(limit);
            }
        }

        // Pagination controls
        renderPaginationControls(currentPage, totalPages);
    }

    function renderPaginationControls(page: number, totalPages: number) {
        const container = document.getElementById("pagination-controls")!;
        const iconBtn = (icon: string, enabled: boolean, targetPage: number) =>
            `<button data-page="${targetPage}" class="p-1 rounded text-text-light-gray ${enabled ? "hover:bg-white/10" : "opacity-50 cursor-default"}" ${!enabled ? "disabled" : ""}>
                <span class="material-symbols-outlined" style="font-size: 20px;">${icon}</span>
            </button>`;

        container.innerHTML = `
            ${iconBtn("first_page", page > 1, 1)}
            ${iconBtn("chevron_left", page > 1, page - 1)}
            <span class="text-xs text-text-light-gray mx-2">
                Page <span class="text-text-off-white font-medium">${page}</span>
                of <span class="text-text-off-white font-medium">${totalPages}</span>
            </span>
            ${iconBtn("chevron_right", page < totalPages, page + 1)}
            ${iconBtn("last_page", page < totalPages, totalPages)}`;

        container.querySelectorAll("button[data-page]").forEach((btn) => {
            btn.addEventListener("click", () => {
                if ((btn as HTMLButtonElement).disabled) return;
                currentPage = parseInt(btn.getAttribute("data-page")!, 10);
                renderTable();
            });
        });
    }

    function escapeHtml(str: string): string {
        const div = document.createElement("div");
        div.textContent = str;
        return div.innerHTML;
    }

    // Export
    async function handleExport(format: "csv" | "xlsx") {
        const exportBtn = document.getElementById("export-toggle-btn")!;
        const originalHtml = exportBtn.innerHTML;
        exportBtn.innerHTML = `<span class="animate-spin material-symbols-outlined" style="font-size: 18px;">progress_activity</span> Exporting...`;
        (exportBtn as HTMLButtonElement).disabled = true;

        try {
            const visibleCols = columns.filter(
                (c) => c.key !== "actions" && !hiddenColumns.has(c.key),
            );
            const exportData = allData.map((row) => {
                const newRow: Record<string, string> = {};
                for (const col of visibleCols) {
                    newRow[col.key] = row[col.key] ?? "";
                }
                return newRow;
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(exportData);
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

            const cleanName = currentFilename.replace(/\.[^/.]+$/, "");

            if (format === "xlsx") {
                XLSX.writeFile(wb, `${cleanName}_export.xlsx`);
            } else {
                const csvString = XLSX.utils.sheet_to_csv(ws);
                const blob = new Blob([csvString], { type: "text/csv" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `${cleanName}_export.csv`;
                a.click();
                URL.revokeObjectURL(url);
            }
        } catch (error) {
            console.error("Export error:", error);
            alert(
                `Failed to export: ${error instanceof Error ? error.message : "Unknown error"}`,
            );
        } finally {
            exportBtn.innerHTML = originalHtml;
            (exportBtn as HTMLButtonElement).disabled = false;
            document.getElementById("export-menu")?.classList.add("hidden");
        }
    }

    // Initialize
    async function init() {
        const urlParams = new URLSearchParams(window.location.search);
        const fileId = urlParams.get("file");

        if (!fileId) {
            showError("No file specified");
            return;
        }

        currentFileId = fileId;

        try {
            const file = await getFile(fileId);
            if (!file) {
                showError("File not found in local storage");
                return;
            }

            currentFilename = file.filename;

            const result = parseCSVString(file.content);
            if (result.error) {
                showError(result.error);
                return;
            }

            allData = result.data;
            if (allData.length === 0) {
                showError("No data found in file");
                return;
            }

            // Derive columns
            const keys = Object.keys(allData[0]);
            columns = keys.map((key) => ({
                key,
                label:
                    key.charAt(0).toUpperCase() +
                    key.slice(1).replace(/_/g, " "),
                align: /quantity|amount|price|revenue|total/i.test(key)
                    ? ("right" as const)
                    : ("left" as const),
            }));
            columns.push({ key: "actions", label: "", align: "left" });

            // Build filter checkboxes
            const filterList = document.getElementById("filter-columns-list")!;
            filterList.innerHTML = columns
                .filter((c) => c.key !== "actions")
                .map(
                    (col) =>
                        `<label class="flex items-center gap-3 px-3 py-2 hover:bg-white/5 rounded-lg cursor-pointer group">
                    <input type="checkbox" value="${col.key}" class="column-checkbox rounded border-border-dark bg-background-dark text-vibrant-blue focus:ring-vibrant-blue w-4 h-4" />
                    <span class="text-sm text-text-off-white group-hover:text-white">${col.label}</span>
                </label>`,
                )
                .join("");

            // Update breadcrumb
            const headerEl = document.querySelector("[data-breadcrumb]");
            if (headerEl) {
                // Breadcrumb update handled by URL
            }

            showState("data");
            renderTable();
        } catch (error) {
            showError(error instanceof Error ? error.message : "Unknown error");
        }
    }

    // Event listeners
    document
        .getElementById("rows-per-page")
        ?.addEventListener("change", (e) => {
            const val = (e.target as HTMLSelectElement).value;
            limit = val === "all" ? 0 : parseInt(val, 10);
            currentPage = 1;
            renderTable();
        });

    // Filter dropdown toggle
    document
        .getElementById("filter-toggle-btn")
        ?.addEventListener("click", (e) => {
            e.stopPropagation();
            document.getElementById("filter-menu")?.classList.toggle("hidden");
            document.getElementById("export-menu")?.classList.add("hidden");
        });

    // Apply column filters
    document
        .getElementById("apply-filters-btn")
        ?.addEventListener("click", () => {
            hiddenColumns.clear();
            document.querySelectorAll(".column-checkbox").forEach((cb) => {
                if ((cb as HTMLInputElement).checked) {
                    hiddenColumns.add((cb as HTMLInputElement).value);
                }
            });
            renderTable();
            document.getElementById("filter-menu")?.classList.add("hidden");
        });

    // Export dropdown toggle
    document
        .getElementById("export-toggle-btn")
        ?.addEventListener("click", (e) => {
            e.stopPropagation();
            document.getElementById("export-menu")?.classList.toggle("hidden");
            document.getElementById("filter-menu")?.classList.add("hidden");
        });

    document
        .getElementById("export-csv")
        ?.addEventListener("click", () => handleExport("csv"));
    document
        .getElementById("export-xlsx")
        ?.addEventListener("click", () => handleExport("xlsx"));

    // Close dropdowns on outside click
    document.addEventListener("click", (e) => {
        const filterContainer = document.getElementById(
            "filter-dropdown-container",
        );
        const exportContainer = document.getElementById("export-container");
        if (filterContainer && !filterContainer.contains(e.target as Node)) {
            document.getElementById("filter-menu")?.classList.add("hidden");
        }
        if (exportContainer && !exportContainer.contains(e.target as Node)) {
            document.getElementById("export-menu")?.classList.add("hidden");
        }
    });

    init();
</script>
