---
import AppLayout from "../layouts/AppLayout.astro";
import Sidebar from "../components/layout/Sidebar.astro";
import Header from "../components/layout/Header.astro";
import MainContent from "../components/layout/MainContent.astro";
import FileTable from "../components/files/FileTable.astro";
---

<AppLayout title="DataFlow - My Files">
  <Sidebar currentPage="files" />
  <div class="flex-1 flex flex-col bg-background-dark">
    <Header currentPage="My Files" breadcrumbItems={[{ label: "My Files" }]} />
    <MainContent>
      <!-- Título y botón -->
      <div
        class="flex-shrink-0 px-4 md:px-8 pt-8 flex items-end justify-between"
      >
        <div class="flex flex-col gap-1">
          <h1 class="text-text-off-white text-3xl font-black tracking-tight">
            My Files
          </h1>
          <p class="text-text-light-gray text-sm">
            Manage and organize your processed data sets.
          </p>
        </div>
        <button
          id="uploadButton"
          class="bg-vibrant-blue hover:bg-primary-hover text-white text-sm font-bold h-10 px-6 rounded-lg shadow-md flex items-center gap-2 transition-all active:scale-95"
        >
          <span class="material-symbols-outlined" style="font-size: 20px;"
            >upload</span
          >
          <span>Upload New</span>
        </button>
        <input
          type="file"
          id="fileInput"
          multiple
          accept=".csv"
          class="hidden"
        />
      </div>

      <!-- Tabla de archivos -->
      <div class="flex-1 overflow-hidden mt-8 px-4 md:px-8 pb-8">
        <FileTable />
      </div>
    </MainContent>
  </div>
</AppLayout>

<script>
  const uploadButton = document.getElementById("uploadButton");
  const fileInput = document.getElementById("fileInput") as HTMLInputElement;

  if (uploadButton && fileInput) {
    uploadButton.addEventListener("click", () => {
      fileInput.click();
    });

    fileInput.addEventListener("change", async () => {
      const files = fileInput.files;
      if (!files || files.length === 0) return;

      const formData = new FormData();
      for (let i = 0; i < files.length; i++) {
        formData.append("files", files[i]);
      }

      try {
        const response = await fetch("/api/upload", {
          method: "POST",
          body: formData,
        });

        if (response.ok) {
          window.location.reload();
        } else {
          const result = await response.json();
          alert("Upload failed: " + (result.message || "Unknown error"));
        }
      } catch (error) {
        console.error("Error uploading files:", error);
        alert("Error uploading files");
      }

      // Reset input value to allow re-uploading same file if needed
      fileInput.value = "";
    });
  }
</script>
