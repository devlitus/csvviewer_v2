---
import AppLayout from "../layouts/AppLayout.astro";
import Sidebar from "../components/layout/Sidebar.astro";
import Header from "../components/layout/Header.astro";
import MainContent from "../components/layout/MainContent.astro";
import FileTable from "../components/files/FileTable.astro";
import ConfirmationModal from "../components/ui/ConfirmationModal.astro";
---

<AppLayout title="DataFlow - My Files">
  <Sidebar currentPage="files" />
  <div class="flex-1 flex flex-col bg-background-dark">
    <Header currentPage="My Files" breadcrumbItems={[{ label: "My Files" }]} />
    <MainContent>
      <!-- Título y botón -->
      <div
        class="flex-shrink-0 px-4 md:px-8 pt-8 flex items-end justify-between"
      >
        <div class="flex flex-col gap-1">
          <h1 class="text-text-off-white text-3xl font-black tracking-tight">
            My Files
          </h1>
          <p class="text-text-light-gray text-sm">
            Manage and organize your processed data sets.
          </p>
        </div>
        <div class="flex items-center gap-3">
          <button
            id="deleteButton"
            class="hidden bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/20 text-sm font-bold h-10 px-6 rounded-lg flex items-center gap-2 transition-all active:scale-95"
          >
            <span class="material-symbols-outlined" style="font-size: 20px;"
              >delete</span
            >
            <span>Delete Selected</span>
          </button>
          <button
            id="uploadButton"
            class="bg-vibrant-blue hover:bg-primary-hover text-white text-sm font-bold h-10 px-6 rounded-lg shadow-md flex items-center gap-2 transition-all active:scale-95"
          >
            <span class="material-symbols-outlined" style="font-size: 20px;"
              >upload</span
            >
            <span>Upload New</span>
          </button>
          <input
            type="file"
            id="fileInput"
            multiple
            accept=".csv"
            class="hidden"
          />
        </div>
      </div>

      <!-- Tabla de archivos -->
      <div class="flex-1 overflow-hidden mt-8 px-4 md:px-8 pb-8">
        <FileTable />
      </div>

      <ConfirmationModal
        id="deleteConfirmModal"
        title="Delete Files"
        description="Are you sure you want to delete the selected files? This action cannot be undone."
        confirmText="Delete"
        confirmType="danger"
      />
    </MainContent>
  </div>

  <script>
    const uploadButton = document.getElementById("uploadButton");
    const fileInput = document.getElementById("fileInput") as HTMLInputElement;

    if (uploadButton && fileInput) {
      uploadButton.addEventListener("click", () => {
        fileInput.click();
      });

      fileInput.addEventListener("change", async () => {
        const files = fileInput.files;
        if (!files || files.length === 0) return;

        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
          formData.append("files", files[i]);
        }

        try {
          const response = await fetch("/api/upload", {
            method: "POST",
            body: formData,
          });

          if (response.ok) {
            window.location.reload();
          } else {
            const result = await response.json();
            alert("Upload failed: " + (result.message || "Unknown error"));
          }
        } catch (error) {
          console.error("Error uploading files:", error);
          alert("Error uploading files");
        }

        // Reset input value to allow re-uploading same file if needed
        fileInput.value = "";
      });
    }
  </script>

  <script>
    // Selection and Delete Logic
    const selectAllCheckbox = document.getElementById(
      "selectAllCheckbox",
    ) as HTMLInputElement;
    const fileCheckboxes = document.querySelectorAll(
      ".file-checkbox",
    ) as NodeListOf<HTMLInputElement>;
    const deleteButton = document.getElementById("deleteButton");

    function updateDeleteButton() {
      const checkedCount = Array.from(fileCheckboxes).filter(
        (cb) => cb.checked,
      ).length;
      if (deleteButton) {
        if (checkedCount > 0) {
          deleteButton.classList.remove("hidden");
        } else {
          deleteButton.classList.add("hidden");
        }
      }
    }

    if (selectAllCheckbox) {
      selectAllCheckbox.addEventListener("change", (e) => {
        const isChecked = (e.target as HTMLInputElement).checked;
        fileCheckboxes.forEach((cb) => {
          cb.checked = isChecked;
        });
        updateDeleteButton();
      });
    }

    fileCheckboxes.forEach((cb) => {
      cb.addEventListener("change", () => {
        updateDeleteButton();

        // Update select all state
        const allChecked = Array.from(fileCheckboxes).every((c) => c.checked);
        const someChecked = Array.from(fileCheckboxes).some((c) => c.checked);

        if (selectAllCheckbox) {
          selectAllCheckbox.checked = allChecked;
          selectAllCheckbox.indeterminate = someChecked && !allChecked;
        }
      });
    });

    if (deleteButton) {
      const modal = document.getElementById("deleteConfirmModal");
      const confirmBtn = modal?.querySelector(".modal-confirm-btn");

      deleteButton.addEventListener("click", () => {
        const selectedFiles = Array.from(fileCheckboxes)
          .filter((cb) => cb.checked)
          .map((cb) => cb.dataset.filename);

        if (selectedFiles.length === 0) return;

        // Update description/title if needed based on count
        const descEl = modal?.querySelector("p");
        if (descEl) {
          descEl.textContent = `Are you sure you want to delete ${selectedFiles.length} file${selectedFiles.length > 1 ? "s" : ""}? This action cannot be undone.`;
        }

        // Show Modal
        if (modal) {
          modal.classList.remove("hidden");
          // Trigger reflow/next frame for animation
          requestAnimationFrame(() => {
            modal.classList.remove("opacity-0");
            modal
              .querySelector("div[class*='relative']")
              ?.classList.remove("scale-95");
            modal
              .querySelector("div[class*='relative']")
              ?.classList.add("scale-100");
          });
        }
      });

      // Handle Confirm Action
      if (confirmBtn) {
        confirmBtn.addEventListener("click", async () => {
          const selectedFiles = Array.from(fileCheckboxes)
            .filter((cb) => cb.checked)
            .map((cb) => cb.dataset.filename);

          try {
            // Show loading state on button
            const originalText = confirmBtn.textContent;
            confirmBtn.textContent = "Deleting...";
            (confirmBtn as HTMLButtonElement).disabled = true;

            const response = await fetch("/api/delete", {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ filenames: selectedFiles }),
            });

            if (response.ok) {
              window.location.reload();
            } else {
              const result = await response.json();
              alert("Delete failed: " + (result.message || "Unknown error"));
              // Reset button
              confirmBtn.textContent = originalText;
              (confirmBtn as HTMLButtonElement).disabled = false;
              // Close modal
              modal
                ?.querySelector(".modal-cancel-btn")
                ?.dispatchEvent(new Event("click"));
            }
          } catch (error) {
            console.error("Error deleting files:", error);
            alert("Error deleting files");
            // Reset button
            confirmBtn.textContent = "Delete";
            (confirmBtn as HTMLButtonElement).disabled = false;
            // Close modal
            modal
              ?.querySelector(".modal-cancel-btn")
              ?.dispatchEvent(new Event("click"));
          }
        });
      }
    }
  </script>
</AppLayout>
