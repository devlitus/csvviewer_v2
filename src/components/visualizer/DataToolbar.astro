---
import Icon from "../ui/Icon.astro";

interface Column {
  key: string;
  label: string;
}

interface Props {
  totalRecords: number;
  startRecord?: number;
  endRecord?: number;
  displayedRecords?: number; // Deprecated but kept for backward compat if needed, though we prefer range
  columns?: Column[];
}

const {
  totalRecords,
  startRecord = 1,
  endRecord = totalRecords,
  displayedRecords, // unused if we use start/end
  columns = [],
} = Astro.props;
---

<div class="flex-shrink-0 px-8 py-6">
  <div
    class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"
  >
    <!-- Título y contador -->
    <div class="flex flex-col gap-1">
      <h2 class="text-xl font-bold text-text-off-white tracking-tight">
        Data Preview
      </h2>
      <p class="text-xs text-text-light-gray">
        Showing {startRecord}-{endRecord} rows from {
          totalRecords.toLocaleString()
        }
        total records
      </p>
    </div>

    <!-- Controles -->
    <div class="flex items-center gap-3 w-full sm:w-auto">
      <!-- Input de filtro -->
      <div class="relative flex-1 sm:flex-initial group">
        <span
          class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-text-light-gray group-focus-within:text-vibrant-blue"
          style="font-size: 18px;"
        >
          filter_alt
        </span>
        <input
          type="text"
          placeholder="Filter columns..."
          class="bg-background-dark border border-border-dark rounded-lg py-1.5 pl-9 pr-3 text-sm text-text-off-white focus:border-vibrant-blue focus:ring-1 focus:ring-vibrant-blue placeholder-text-light-gray w-full sm:w-64 transition-colors"
        />
      </div>

      <!-- Filter Dropdown -->
      <div class="relative" id="filter-dropdown-container">
        <button
          id="filter-toggle-btn"
          class="flex items-center gap-2 px-3 py-1.5 bg-surface-card border border-border-dark rounded-lg text-text-light-gray hover:text-text-off-white hover:border-text-light-gray/50 text-sm font-medium transition-colors"
        >
          <Icon name="tune" size="sm" />
          Filter
        </button>

        <!-- Dropdown Menu -->
        <div
          id="filter-menu"
          class="hidden absolute right-0 top-full mt-2 w-56 bg-surface-card border border-border-dark rounded-xl shadow-2xl z-50 overflow-hidden flex flex-col"
        >
          <div class="px-3 py-2 border-b border-border-dark bg-surface-card/50">
            <span
              class="text-xs font-semibold text-text-light-gray uppercase tracking-wider"
              >Select Columns</span
            >
          </div>
          <div class="max-h-64 overflow-y-auto p-1">
            {
              columns.map((col) => (
                <label class="flex items-center gap-3 px-3 py-2 hover:bg-white/5 rounded-lg cursor-pointer group">
                  <input
                    type="checkbox"
                    value={col.key}
                    class="column-checkbox rounded border-border-dark bg-background-dark text-vibrant-blue focus:ring-vibrant-blue focus:ring-offset-0 focus:ring-offset-transparent w-4 h-4"
                  />
                  <span class="text-sm text-text-off-white group-hover:text-white">
                    {col.label}
                  </span>
                </label>
              ))
            }
          </div>
          <div
            class="p-2 border-t border-border-dark bg-surface-card/50 flex justify-end"
          >
            <button
              id="apply-filters-btn"
              class="text-xs font-semibold text-vibrant-blue hover:text-primary-hover px-2 py-1 rounded"
              >Apply</button
            >
          </div>
        </div>
      </div>

      <!-- Botón Export -->
      <div class="relative" id="export-container">
        <button
          id="export-toggle-btn"
          class="flex items-center gap-2 px-3 py-1.5 bg-vibrant-blue hover:bg-primary-hover text-white rounded-lg text-sm font-bold transition-colors shadow-lg shadow-vibrant-blue/20"
        >
          <Icon name="download" size="sm" />
          Export
          <Icon name="expand_more" size="sm" />
        </button>

        <!-- Export Dropdown -->
        <div
          id="export-menu"
          class="hidden absolute right-0 top-full mt-2 w-48 bg-surface-card border border-border-dark rounded-xl shadow-2xl z-50 overflow-hidden flex flex-col"
        >
          <button
            id="export-csv"
            class="flex items-center gap-3 px-4 py-3 hover:bg-white/5 text-left transition-colors group border-b border-border-dark"
          >
            <Icon name="description" size="sm" class="text-vibrant-blue" />
            <div class="flex flex-col">
              <span class="text-sm font-medium text-text-off-white">CSV</span>
              <span class="text-xs text-text-light-gray">Comma separated</span>
            </div>
          </button>
          <button
            id="export-xlsx"
            class="flex items-center gap-3 px-4 py-3 hover:bg-white/5 text-left transition-colors group"
          >
            <Icon name="table_view" size="sm" class="text-emerald-500" />
            <div class="flex flex-col">
              <span class="text-sm font-medium text-text-off-white">Excel</span>
              <span class="text-xs text-text-light-gray">.xlsx Spreadsheet</span
              >
            </div>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Client-side logic for filter dropdown
  const filterBtn = document.getElementById("filter-toggle-btn");
  const filterMenu = document.getElementById("filter-menu");
  const applyBtn = document.getElementById("apply-filters-btn");
  const checkboxes = document.querySelectorAll(".column-checkbox");
  const dropdownContainer = document.getElementById(
    "filter-dropdown-container",
  );

  if (filterBtn && filterMenu && applyBtn && dropdownContainer) {
    // Toggle dropdown
    filterBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      filterMenu.classList.toggle("hidden");
      exportMenu?.classList.add("hidden"); // Close export menu if open
    });

    // Close when clicking outside
    document.addEventListener("click", (e) => {
      if (!dropdownContainer.contains(e.target as Node)) {
        filterMenu.classList.add("hidden");
      }
      if (exportContainer && !exportContainer.contains(e.target as Node)) {
        exportMenu?.classList.add("hidden");
      }
    });

    // Stop propagation inside menu
    filterMenu.addEventListener("click", (e) => {
      e.stopPropagation();
    });

    // Apply filters
    applyBtn.addEventListener("click", () => {
      const hiddenColumns = new Set();
      checkboxes.forEach((checkbox) => {
        if ((checkbox as HTMLInputElement).checked) {
          hiddenColumns.add((checkbox as HTMLInputElement).value);
        }
      });

      // Update table visibility
      // Targets both headers (th) and cells (td) with data-col attribute
      const tableCells = document.querySelectorAll("[data-col]");
      tableCells.forEach((cell) => {
        const colKey = cell.getAttribute("data-col");
        if (colKey && hiddenColumns.has(colKey)) {
          cell.classList.add("hidden");
        } else {
          cell.classList.remove("hidden");
        }
      });

      // Close menu
      filterMenu.classList.add("hidden");
    });
  }

  // Export functionality
  const exportBtn = document.getElementById("export-toggle-btn");
  const exportMenu = document.getElementById("export-menu");
  const exportContainer = document.getElementById("export-container");

  if (exportBtn && exportMenu) {
    exportBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      exportMenu.classList.toggle("hidden");
      if (filterMenu) filterMenu.classList.add("hidden"); // Close filter menu
    });
  }

  const handleExport = (format: string) => {
    const urlParams = new URLSearchParams(window.location.search);
    const filename = urlParams.get("file");

    if (!filename) return;

    // Get hidden columns (re-using existing checkboxes)
    const hiddenColumns: string[] = [];
    checkboxes.forEach((checkbox) => {
      if ((checkbox as HTMLInputElement).checked) {
        hiddenColumns.push((checkbox as HTMLInputElement).value);
      }
    });

    const exportUrl = new URL("/api/export", window.location.origin);
    exportUrl.searchParams.set("file", filename);
    exportUrl.searchParams.set("format", format);
    if (hiddenColumns.length > 0) {
      exportUrl.searchParams.set("exclude", hiddenColumns.join(","));
    }

    window.location.href = exportUrl.toString();
    exportMenu?.classList.add("hidden");
  };

  document
    .getElementById("export-csv")
    ?.addEventListener("click", () => handleExport("csv"));
  document
    .getElementById("export-xlsx")
    ?.addEventListener("click", () => handleExport("xlsx"));
</script>
