---
import Pagination from "./Pagination.astro";
---

<div
    class="h-full border border-border-dark/50 rounded-xl bg-background-dark overflow-hidden flex flex-col"
>
    <!-- Tabla con scroll -->
    <div class="overflow-y-auto">
        <table class="w-full text-left border-collapse">
            <!-- Thead sticky -->
            <thead
                class="sticky top-0 bg-background-dark border-b border-border-dark z-10"
            >
                <tr>
                    <th
                        class="px-6 py-4 text-xs font-semibold text-text-light-gray uppercase tracking-wider"
                    >
                        <div class="flex items-center gap-3">
                            <div class="flex items-center justify-center p-2">
                                <input
                                    type="checkbox"
                                    id="selectAllCheckbox"
                                    class="w-4 h-4 rounded border-gray-600 bg-gray-700 text-vibrant-blue focus:ring-vibrant-blue focus:ring-offset-gray-800"
                                />
                            </div>
                            File Name
                        </div>
                    </th>
                    <th
                        class="px-6 py-4 text-xs font-semibold text-text-light-gray uppercase tracking-wider"
                    >
                        Date Uploaded
                    </th>
                    <th
                        class="px-6 py-4 text-xs font-semibold text-text-light-gray uppercase tracking-wider"
                    >
                        File Size
                    </th>
                    <th
                        class="px-6 py-4 text-xs font-semibold text-text-light-gray uppercase tracking-wider"
                    >
                        Status
                    </th>
                    <th class="px-6 py-4 text-right"></th>
                </tr>
            </thead>

            <!-- Tbody -->
            <tbody id="file-table-body" class="divide-y divide-border-dark/40">
                <!-- Rendered by client script -->
            </tbody>
        </table>
    </div>

    <!-- PaginaciÃ³n -->
    <div id="pagination-container">
        <Pagination
            currentPage={1}
            totalPages={1}
            totalFiles={0}
            filesPerPage={9}
        />
    </div>
</div>

<script>
    import { getAllFiles } from "../../lib/indexeddb";
    import type { CSVFile } from "../../lib/types";

    const icons = [
        "table_view",
        "description",
        "analytics",
        "dataset",
        "grid_on",
    ];
    const iconColors = [
        "#22C55E",
        "#007AFF",
        "#A855F7",
        "#F59E0B",
        "#EF4444",
        "#EC4899",
    ];
    const iconColorSchemes: Record<string, { bg: string; text: string }> = {
        "#22C55E": { bg: "bg-green-500/10", text: "text-green-400" },
        "#007AFF": { bg: "bg-vibrant-blue/10", text: "text-vibrant-blue" },
        "#A855F7": { bg: "bg-purple-500/10", text: "text-purple-400" },
        "#F59E0B": { bg: "bg-amber-500/10", text: "text-amber-400" },
        "#EF4444": { bg: "bg-red-500/10", text: "text-red-400" },
        "#EC4899": { bg: "bg-pink-500/10", text: "text-pink-400" },
    };

    function formatSize(bytes: number): string {
        if (bytes === 0) return "0 B";
        const k = 1024;
        const sizes = ["B", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + " " + sizes[i];
    }

    function getRelativeTime(timestamp: number): string {
        const diffInSeconds = Math.floor((Date.now() - timestamp) / 1000);
        if (diffInSeconds < 60) return "Just now";
        if (diffInSeconds < 3600)
            return `${Math.floor(diffInSeconds / 60)} mins ago`;
        if (diffInSeconds < 86400)
            return `${Math.floor(diffInSeconds / 3600)} hours ago`;
        if (diffInSeconds < 172800) return "Yesterday";
        return new Date(timestamp).toLocaleDateString("en-US", {
            month: "short",
            day: "numeric",
            year: "numeric",
        });
    }

    function getFilenameWithoutExt(filename: string): string {
        const lastDot = filename.lastIndexOf(".");
        return lastDot > 0 ? filename.substring(0, lastDot) : filename;
    }

    function seededRandom(seed: string): number {
        let hash = 0;
        for (let i = 0; i < seed.length; i++) {
            hash = (hash << 5) - hash + seed.charCodeAt(i);
            hash |= 0;
        }
        return Math.abs(hash);
    }

    function renderRow(file: CSVFile): string {
        const seed = seededRandom(file.id);
        const icon = icons[seed % icons.length];
        const color = iconColors[seed % iconColors.length];
        const scheme = iconColorSchemes[color] || iconColorSchemes["#007AFF"];
        const displayName = getFilenameWithoutExt(file.filename);

        return `<tr class="hover:bg-white/5 transition-colors cursor-pointer group"
      onclick="window.location.href='/visualizer?file=${file.id}'">
      <td class="px-6 py-4">
        <div class="flex items-center gap-3">
          <div class="flex items-center justify-center p-2 rounded-lg hover:bg-white/5 transition-colors" onclick="event.stopPropagation()">
            <input type="checkbox" class="w-4 h-4 rounded border-gray-600 bg-gray-700 text-vibrant-blue focus:ring-vibrant-blue focus:ring-offset-gray-800 file-checkbox"
              data-file-id="${file.id}" data-filename="${file.filename}" />
          </div>
          <div class="p-2 ${scheme.bg} ${scheme.text} rounded-lg">
            <span class="material-symbols-outlined" style="font-size: 22px;">${icon}</span>
          </div>
          <span class="text-sm font-semibold text-text-off-white group-hover:text-vibrant-blue transition-colors">${displayName}</span>
        </div>
      </td>
      <td class="px-6 py-4 text-sm text-text-light-gray">${getRelativeTime(file.uploadDate)}</td>
      <td class="px-6 py-4 text-sm text-text-light-gray">${formatSize(file.size)}</td>
      <td class="px-6 py-4">
        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-green-500/10 text-green-400 border border-green-500/20">
          <span class="w-1.5 h-1.5 rounded-full bg-green-400"></span>Processed
        </span>
      </td>
      <td class="px-6 py-4 text-right">
        <button class="text-text-light-gray hover:text-text-off-white p-1 rounded-md hover:bg-white/10 transition-colors">
          <span class="material-symbols-outlined" style="font-size: 20px;">more_vert</span>
        </button>
      </td>
    </tr>`;
    }

    function renderPagination(
        currentPage: number,
        totalPages: number,
        totalFiles: number,
        filesPerPage: number,
    ) {
        const container = document.getElementById("pagination-container");
        if (!container) return;

        const startFile = (currentPage - 1) * filesPerPage + 1;
        const endFile = Math.min(currentPage * filesPerPage, totalFiles);

        type PageItem = { type: "page"; number: number } | { type: "ellipsis" };
        const pageItems: PageItem[] = [];
        const MAX_VISIBLE = 7;

        if (totalPages <= MAX_VISIBLE) {
            for (let i = 1; i <= totalPages; i++)
                pageItems.push({ type: "page", number: i });
        } else {
            pageItems.push({ type: "page", number: 1 });
            if (currentPage < 5) {
                for (let i = 2; i < 6; i++)
                    pageItems.push({ type: "page", number: i });
                pageItems.push({ type: "ellipsis" });
                pageItems.push({ type: "page", number: totalPages });
            } else if (currentPage > totalPages - 4) {
                pageItems.push({ type: "ellipsis" });
                for (let i = totalPages - 4; i <= totalPages; i++)
                    pageItems.push({ type: "page", number: i });
            } else {
                pageItems.push({ type: "ellipsis" });
                pageItems.push({ type: "page", number: currentPage - 1 });
                pageItems.push({ type: "page", number: currentPage });
                pageItems.push({ type: "page", number: currentPage + 1 });
                pageItems.push({ type: "ellipsis" });
                pageItems.push({ type: "page", number: totalPages });
            }
        }

        const pagesHtml = pageItems
            .map((item) => {
                if (item.type === "ellipsis")
                    return `<span class="text-text-light-gray px-1">...</span>`;
                const active = currentPage === item.number;
                return `<a href="?page=${item.number}" class="px-3 py-1.5 rounded-lg border text-xs font-medium transition-colors ${active ? "border-vibrant-blue bg-vibrant-blue/10 text-vibrant-blue font-bold" : "border-border-dark text-text-light-gray hover:bg-white/5"}">${item.number}</a>`;
            })
            .join("");

        container.innerHTML = `
      <div class="mt-auto border-t border-border-dark px-6 py-4 flex items-center justify-between bg-background-dark">
        <span class="text-xs text-text-light-gray">
          Showing <span class="text-text-off-white font-medium">${totalFiles > 0 ? startFile : 0}-${endFile}</span>
          of <span class="text-text-off-white font-medium">${totalFiles}</span> files
        </span>
        <div class="flex items-center gap-2">
          <a ${currentPage > 1 ? `href="?page=${currentPage - 1}"` : ""}
            class="p-1.5 rounded-lg border border-border-dark text-text-light-gray transition-colors flex items-center justify-center ${currentPage === 1 ? "opacity-30 cursor-not-allowed" : "hover:bg-white/5"}">
            <span class="material-symbols-outlined" style="font-size: 20px;">chevron_left</span>
          </a>
          ${pagesHtml}
          <a ${currentPage < totalPages ? `href="?page=${currentPage + 1}"` : ""}
            class="p-1.5 rounded-lg border border-border-dark text-text-light-gray transition-colors flex items-center justify-center ${currentPage >= totalPages ? "opacity-30 cursor-not-allowed" : "hover:bg-white/5"}">
            <span class="material-symbols-outlined" style="font-size: 20px;">chevron_right</span>
          </a>
        </div>
      </div>`;
    }

    async function loadFiles() {
        const tbody = document.getElementById("file-table-body");
        if (!tbody) return;

        const files = await getAllFiles();
        const filesPerPage = 9;
        const urlParams = new URLSearchParams(window.location.search);
        const currentPage = Math.max(
            1,
            parseInt(urlParams.get("page") || "1", 10),
        );
        const totalPages = Math.max(1, Math.ceil(files.length / filesPerPage));

        const start = (currentPage - 1) * filesPerPage;
        const paginated = files.slice(start, start + filesPerPage);

        if (paginated.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-16 text-center text-text-light-gray">No files uploaded yet</td></tr>`;
        } else {
            tbody.innerHTML = paginated.map(renderRow).join("");
        }

        renderPagination(currentPage, totalPages, files.length, filesPerPage);
    }

    loadFiles();
</script>
