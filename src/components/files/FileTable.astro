---
import FileTableRow from "./FileTableRow.astro";
import Pagination from "./Pagination.astro";

interface FileData {
  id: string;
  filename: string;
  originalFilename?: string;
  dateUploaded: string;
  fileSize: string;
  status: "processed" | "mapping_needed" | "error";
  icon: string;
  iconColor: string;
}

interface Props {
  files?: FileData[];
}

const { files: propFiles } = Astro.props as Props;

import fs from "node:fs";
import path from "node:path";
import { randomUUID } from "node:crypto";

const FILES_DIR = path.join(process.cwd(), "files");

// Helper for formatting file size
function formatSize(bytes: number): string {
  if (bytes === 0) return "0 B";
  const k = 1024;
  const sizes = ["B", "KB", "MB", "GB"];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + " " + sizes[i];
}

// Helper for relative time
function getRelativeTime(date: Date): string {
  const now = new Date();
  const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);

  if (diffInSeconds < 60) return "Just now";
  if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} mins ago`;
  if (diffInSeconds < 86400)
    return `${Math.floor(diffInSeconds / 3600)} hours ago`;
  if (diffInSeconds < 172800) return "Yesterday";
  return date.toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
    year: "numeric",
  });
}

// Helper to get filename without extension
function getFilenameWithoutExt(filename: string): string {
  return path.basename(filename, path.extname(filename));
}

const icons = ["table_view", "description", "analytics", "dataset", "grid_on"];
const iconColors = [
  "#22C55E",
  "#007AFF",
  "#A855F7",
  "#F59E0B",
  "#EF4444",
  "#EC4899",
]; // Using hex codes as strings to match FileData interface if needed, or if the component expects class names we might need to adjust.
// Looking at the props, iconColor is string. In RecentFiles it was hex.
// In the hardcoded data here it was 'green', 'blue', etc.
// But the RecentFiles implementation used Hex.
// Let's see how FileTableRow uses it.
// If it expects tailwind classes (text-green-500), sending hex might break it if it doesn't handle inline styles.
// However, the user asked to "do the same".
// Let's assume FileTableRow can handle what we send or we might need to adjust FileTableRow.
// Re-checking FileTable hardcoded data: 'green', 'blue'.
// RecentFiles hardcoded data: '#22C55E'.
// I should probably check FileTableRow to be sure, but for now I will use the hex codes from RecentFiles since "do the same" implies same visual result.
// Actually, let's verify FileTableRow quickly if possible?
// No, I'm in the middle of a replace. I'll stick to hex codes to match RecentFiles logic.

let files: FileData[] = [];

if (propFiles) {
  files = propFiles;
} else {
  try {
    if (!fs.existsSync(FILES_DIR)) {
      fs.mkdirSync(FILES_DIR, { recursive: true });
    }

    const dirFiles = fs.readdirSync(FILES_DIR);

    const fileStats = dirFiles
      .filter((file) => !file.startsWith("."))
      .map((filename) => ({
        filename,
        stats: fs.statSync(path.join(FILES_DIR, filename)),
      }))
      .sort((a, b) => b.stats.mtime.getTime() - a.stats.mtime.getTime());

    files = fileStats.map((item) => ({
      id: randomUUID(),
      filename: getFilenameWithoutExt(item.filename),
      originalFilename: item.filename, // Keep original
      fileSize: formatSize(item.stats.size),
      dateUploaded: getRelativeTime(item.stats.mtime),
      status: "processed",
      icon: icons[Math.floor(Math.random() * icons.length)],
      iconColor: iconColors[Math.floor(Math.random() * iconColors.length)],
    }));
  } catch (error) {
    console.error("Error reading files:", error);
    files = [];
  }
}

// Pagination Logic
const page = Number(Astro.url.searchParams.get("page") || 1);
const filesPerPage = 9; // Adjust as needed
const totalFiles = files.length;
const totalPages = Math.ceil(totalFiles / filesPerPage);

const start = (page - 1) * filesPerPage;
const end = start + filesPerPage;
const paginatedFiles = files.slice(start, end);
---

<div
  class="h-full border border-border-dark/50 rounded-xl bg-background-dark overflow-hidden flex flex-col"
>
  <!-- Tabla con scroll -->
  <div class="overflow-y-auto">
    <table class="w-full text-left border-collapse">
      <!-- Thead sticky -->
      <thead
        class="sticky top-0 bg-background-dark border-b border-border-dark z-10"
      >
        <tr>
          <th
            class="px-6 py-4 text-xs font-semibold text-text-light-gray uppercase tracking-wider"
          >
            <div class="flex items-center gap-3">
              <div class="flex items-center justify-center p-2">
                <input
                  type="checkbox"
                  id="selectAllCheckbox"
                  class="w-4 h-4 rounded border-gray-600 bg-gray-700 text-vibrant-blue focus:ring-vibrant-blue focus:ring-offset-gray-800"
                />
              </div>
              File Name
            </div>
          </th>
          <th
            class="px-6 py-4 text-xs font-semibold text-text-light-gray uppercase tracking-wider"
          >
            Date Uploaded
          </th>
          <th
            class="px-6 py-4 text-xs font-semibold text-text-light-gray uppercase tracking-wider"
          >
            File Size
          </th>
          <th
            class="px-6 py-4 text-xs font-semibold text-text-light-gray uppercase tracking-wider"
          >
            Status
          </th>
          <th class="px-6 py-4 text-right"></th>
        </tr>
      </thead>

      <!-- Tbody -->
      <tbody class="divide-y divide-border-dark/40">
        {
          paginatedFiles.map((file) => (
            <FileTableRow
              filename={file.filename}
              fullFilename={file.originalFilename || file.filename}
              dateUploaded={file.dateUploaded}
              fileSize={file.fileSize}
              status={file.status}
              icon={file.icon}
              iconColor={file.iconColor}
            />
          ))
        }
      </tbody>
    </table>
  </div>

  <!-- PaginaciÃ³n -->
  <Pagination
    currentPage={page}
    totalPages={totalPages}
    totalFiles={totalFiles}
    filesPerPage={filesPerPage}
  />
</div>
