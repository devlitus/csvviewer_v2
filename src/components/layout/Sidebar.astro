---
import Logo from "../navigation/Logo.astro";
import NavMenu from "../navigation/NavMenu.astro";
import Button from "../ui/Button.astro";
import UserProfile from "../user/UserProfile.astro";

interface Props {
  currentPage?: string;
}

const { currentPage = "upload" } = Astro.props as Props;
---

<aside
  id="main-sidebar"
  transition:persist
  class="fixed inset-y-0 left-0 z-50 w-64 bg-background-dark border-r border-border-dark flex flex-col h-full transform -translate-x-full transition-transform duration-300 ease-in-out md:translate-x-0 md:static md:flex"
>
  <!-- Logo -->
  <div
    class="p-6 border-b border-border-dark flex justify-between items-center"
  >
    <Logo />
    <button
      id="close-sidebar"
      class="md:hidden text-text-light-gray hover:text-white"
    >
      <span class="material-symbols-outlined">close</span>
    </button>
  </div>

  <!-- Navigation Menu -->
  <div class="flex-1 px-4 py-6 overflow-y-auto">
    <NavMenu currentPage={currentPage} />
  </div>

  <!-- User Profile -->
  <div class="px-2 py-4 border-t border-border-dark">
    <UserProfile />
  </div>
</aside>

<!-- Overlay for mobile -->
<div
  id="sidebar-overlay"
  transition:persist
  class="fixed inset-0 bg-black/50 z-40 hidden opacity-0 transition-opacity duration-300 md:hidden"
>
</div>

<script>
  const sidebar = document.getElementById("main-sidebar");
  const overlay = document.getElementById("sidebar-overlay");
  const closeBtn = document.getElementById("close-sidebar");

  function closeSidebar() {
    sidebar?.classList.add("-translate-x-full");
    overlay?.classList.add("hidden", "opacity-0");
    overlay?.classList.remove("opacity-100");
  }

  closeBtn?.addEventListener("click", closeSidebar);
  overlay?.addEventListener("click", closeSidebar);

  // Listen for open event from Header
  document.addEventListener("open-sidebar", () => {
    sidebar?.classList.remove("-translate-x-full");
    overlay?.classList.remove("hidden");
    // Small delay to allow display:block to apply before opacity transition
    setTimeout(() => {
      overlay?.classList.add("opacity-100");
      overlay?.classList.remove("opacity-0");
    }, 10);
  });

  // Update active nav item on SPA navigation
  function updateActiveNav() {
    const path = window.location.pathname;
    document.querySelectorAll("a[data-nav-href]").forEach((link) => {
      const href = link.getAttribute("data-nav-href")!;
      const isActive = href === "/" ? path === "/" : path.startsWith(href);
      const icon = link.querySelector(".material-symbols-outlined");

      if (isActive) {
        link.className = link.className
          .replace(/text-text-light-gray hover:bg-white\/5 hover:text-text-off-white transition-colors/g, "")
          .replace(/bg-vibrant-blue\/10 text-vibrant-blue font-semibold/g, "")
          + " bg-vibrant-blue/10 text-vibrant-blue font-semibold";
        icon?.classList.add("filled");
      } else {
        link.className = link.className
          .replace(/bg-vibrant-blue\/10 text-vibrant-blue font-semibold/g, "")
          .replace(/text-text-light-gray hover:bg-white\/5 hover:text-text-off-white transition-colors/g, "")
          + " text-text-light-gray hover:bg-white/5 hover:text-text-off-white transition-colors";
        icon?.classList.remove("filled");
      }
    });
  }

  document.addEventListener("astro:page-load", updateActiveNav);
</script>

<style>
  aside::-webkit-scrollbar {
    width: 6px;
  }

  aside::-webkit-scrollbar-thumb {
    background: var(--color-border-dark);
    border-radius: 3px;
  }
</style>
